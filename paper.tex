\documentclass[conference]{IEEEtran}

% correct bad hyphenation here
\hyphenation{op-tical net-works semi-conduc-tor}


\usepackage{float}
\usepackage[utf8]{inputenc}
\usepackage{url}
\usepackage{array}
\usepackage{cite}
\usepackage{microtype}

% Centered columns
\newcolumntype{V}{>{\bf\centering\arraybackslash} m{.2\linewidth} }

% Default fixed font does not support bold face
\DeclareFixedFont{\ttb}{T1}{txtt}{bx}{n}{12} % for bold
\DeclareFixedFont{\ttm}{T1}{txtt}{m}{n}{12}  % for normal

% Custom colors
\usepackage{color}
\definecolor{deepblue}{rgb}{0,0,0.5}
\definecolor{deepred}{rgb}{0.6,0,0}
\definecolor{deepgreen}{rgb}{0,0.5,0}

\usepackage{listings}

% Python style for highlighting
\newcommand\pythonstyle{\lstset{
language=Python,
basicstyle=\ttm,
otherkeywords={self},
keywordstyle=\ttb\color{deepblue},
emphstyle=\ttb\color{deepred},
stringstyle=\color{deepgreen},
frame=tb,
showstringspaces=false
}}


% Python environment
\lstnewenvironment{python}[1][]
{
\pythonstyle
\lstset{#1}
}
{}


\begin{document}

\title{fl0w 2.0 - a development environment for the\\ KIPR Wallaby}
\author{\IEEEauthorblockN{Philip Trauner}
\IEEEauthorblockA{School of Computer Engineering\\
HTBLuVA Wiener Neustadt\\
Email: philip.trauner@arztpraxis.io}
\and
\IEEEauthorblockN{Christoph Heiss}
\IEEEauthorblockA{School of Computer Engineering\\
HTBLuVA Wiener Neustadt\\
Email: me@christoph-heiss.me}
\and
\IEEEauthorblockN{Sebastian Schaffler}
\IEEEauthorblockA{School of Computer Engineering\\
HTBLuVA Wiener Neustadt\\
Email: se.schaffler@gmail.com}}

\maketitle


\begin{abstract}
This publication introduces fl0w, an alternative\\ development environment for the KIPR Wallaby.\\ The aim of fl0w is to improve the robotics program development experience. It focuses on the components that make up fl0w, namely a file synchronization protocol that maintains a consistent state across all connected controllers, a route based and data type preserving network protocol with peer-to-peer piping capabilities, a discovery protocol that connects all controllers together automatically, a Sublime Text 3\cite{Sublime Text 3:Sublime HQ} plugin which enables in-line sensor readouts, program execution, program editing, and keyboard shortcuts, and a browser-based management front-end to manage the controller fleet.\\
\end{abstract}

\begin{IEEEkeywords}
file synchronization, networking, LAN discovery, development environment
\end{IEEEkeywords}



\section{Introduction}
fl0w was developed out of a need for a fast, reliable and wireless workflow solution that can compete with the currently available offerings like Harrogate\cite{Harrogate:KIPR}. Its goals are to transform the connected controllers into a redundant fleet of logical units that share the same binaries and source code, real-time in-line sensor readouts, programming as well as robot management inside Sublime Text 3\cite{Sublime Text 3:Sublime HQ}, a browser-based front-end and the ability to connect to a wireless access point.

\section{Implementation}
All fl0w components emphasize shared code and are therefor written in Python 3.3.6\cite{Python 3.3.6:Python Foundation} to remain compatible with the Sublime Text 3\cite{Sublime Text 3:Sublime HQ} plugin environment. Python was chosen as the implementation language for fl0w because of its rich standard library and its lightweight virtual machine that can run on a Wallaby controller with acceptable speed. A pre-compiled version of Python \cite{Python 3.3.6:Python Foundation} is bundled with the fl0w installer, r0adrunner, because it is not present on the Wallaby by default. All fl0w components are designed as libraries to allow for integration into other projects. fl0w utilities a client-server networking model with random server assignment.

\section{Components}

\subsection{undergr0und}
undergr0und\cite{undergr0und:Philip Trauner} is an asynchronous, route based, largely programming language agnostic, and data type preserving network protocol with peer-to-peer piping capabilities.
It automatically converts data into a transferable format and prepends binary headers to allow for reconstruction on the other end.

\begin{figure}[H]
\centering
	\begin{tabular}{*{3}{V}}
		Data type & Route ID & Data \\ \hline
		1 & 2 & * \\
	\end{tabular}
	\caption{The binary encoding of undergr0und (in bytes)}
\label{fig:undergr0und_header}
\end{figure}


The Python\cite{Python 3.3.6:Python Foundation} version is built on top of a fork of ws4py\cite{ws4py:Philip Trauner} and the JavaScript version utilizes regular WebSockets\cite{The WebSocket Protocol:A. Melnikov} in arraybuffer mode. Only the Python version can be started in server mode because It was created to mitigate the problems fl0ws explorative development style created. Instead of one monolithic network protocol, undergr0und emphasizes small sub protocols. This was done because all monolithic designs became too inconsistent. undergr0und\cite{undergr0und:Philip Trauner} manages itself through its own concepts.

\subsubsection{undergr0und.js}
undergr0und.js is the feature complete client-side JavaScript port of undergr0und. It utilizes node-jspack to unpack the binary messages it receives from the undergr0und server. It is based on the Python version but does not implement the server because there is currently no need for that functionality.

\subsubsection{Exchange table}
To reduce the required additional bandwidth per message that is introduced with variable character count routes, a numbered route lookup table is generated on startup by clients and the server. Before any communication takes place these lookup tables are exchanged. Route ID 0 is reserved for self management purposes.

\begin{figure}[H]
\centering
\begin{python}
>>> routes = {"echo": Echo(),
...    "help": Help()}
>>> create_exchange_map(routes)
{0: "meta", 1: "echo", 2: "help"}
\end{python}
\caption{Creation of exchange maps}
\end{figure}

\subsubsection{Data type preservation}
The original type of the data segment is present inside the header $($see Figure ~\ref{fig:undergr0und_header}$)$ to accurately reconstruct sent data on the other end. JSON\cite{JSON:T. Bray Ed.} is used to transfer lists and dictionaries, and regular ASCII encoded strings are utilized to transfer integers, floats, null/none types and strings.

\subsubsection{Route}
A client$\,\to\,$server / server$\,\to\,$client construct. Invoked with the {\color{deepgreen}"send"} call.

\subsubsection{Pipe}
A client$\,\to\,$server$\,\to\,$client construct. Invoked with the {\color{deepgreen}"pipe"} call. Clients can be targeted with unique IDs that are generated randomly for all connected peers by the server. There is no predefined mechanism in the network protocol that exposed these peer IDs, the application using undergr0und\cite{undergr0und:Philip Trauner} has to provide a way of making them available. This approach allows for more flexibility if additional peer-metadata has to be provided.
Pipe messages are packaged inside regular route messages with additional headers in the data segment. A server route called {\color{deepgreen}"pipe"} unpacks the regular and the extended headers and forwards the message to the targeted peer. The original sender ID is always included for a possible response.

\subsection{behem0th}
behem0th is a continuous network file synchronization protocol developed out of the need for an embeddable solution that would not require an additional background program to be present on the system running Sublime Text 3\cite{Sublime Text 3:Sublime HQ}, instead utilizing its plugin environment. It uses a client-server networking model without peer-to-peer capabilities to stay in line with undergr0und. It uses regular sockets instead of WebSockets\cite{The WebSocket Protocol:A. Melnikov} because the in-browser components of fl0w never interact with it. File system events are detected with watchdog


\subsubsection{Synchronization}
Files are synchronized based on modification time and md5 hash. Sync conflicts are resolved on the server.

\subsubsection{Transfer}
behem0th neither sends nor receives files as a whole, instead it transmits the file size followed by data block which are written to a temporary file on disk. This is done to allow the transfer of files that are large enough to cause out of system memory situations.

\subsubsection{Metadata}
Metadata

\subsection{dashb0ard}
dashb0ard is a single-page web front-end designed to manage the fl0w fleet. It can be used to configure connected controllers and obtain information from them. It utilities the JavaScript version of undergr0und to retrieve data from fl0w, Flot\cite{Flot:David Schnur} to display graphs and jQuery\cite{jQuery:jQuery Foundation} for DOM manipulation.

\subsubsection{Sensor readouts}


\subsection{edit0r}
edit0r is the Sublime Text 3 plugin. It is modeled as a fl0w client and allows for remote robot management, source code synchronization as well as in line sensor readouts. It also provides quick access to dashb0ard, which is required because the IP addresses of controllers are not always static. behem0th\cite{behem0th:Christoph Heiss} is embedded into edit0r and enables the source code synchronization.

\subsubsection{Robot selection}
fl0ws networking model allows for the management of multiple controllers without a direct connection to them. The controller hostname is utilised to identify the robots in the user-interface. Controllers can be selected to obtain additional functionality such as in-line sensor readouts and keyboard shortcuts.

\subsubsection{Robot management}
Botball programs can be started (keyboard shortcut: F8) and/or stopped (keyboard shortcut: F9).
Additionally, edit0r allows for modification of the controller hostname, playback of a sound for identification purposes, listing of running processes, power management functionality (reboot, shutdown) and running programs.

\subsubsection{In-line sensor readouts}
Invocations of the functions "analog" and "digital" are located every time the content of a view changes and the parameters of the calls are grouped across views. edit0r subscribes to all required sensor ports by requesting them from the currently selected controller. The controller keeps track of all subscriptions to sensors and continuously transmits the appropriate values to the Sublime Text\cite{Sublime Text 3:Sublime HQ} plugin. Sublime Text \cite{Sublime Text 3:Sublime HQ} phantoms are created as soon as new sensor values are available. This approach has the disadvantage of higher than usual processor utilization by edit0r, because phantoms were primarily designed to display infrequently updated content. To partially circumvent this, sensor readouts can be disabled as well.\\
In-line sensor readouts can be toggled on a per view basis with a keyboard shortcut (default F10).

\subsection{disc0very}
fl0w is using a client-server networking model but because of it's distributed nature the server is chosen randomly. This is implemented with UDP broadcasts that coordinate which controllers become clients and which controller becomes the server.

\subsection{r0adrunner}
r0adrunner is the installer of fl0w.

\subsection{fl0w}
fl0w itself is the combination of all other components split into Wallaby client and server.

\subsubsection{Wallaby}


\section{Conclusion}



% section* for acknowledgment
\section*{Acknowledgment}
The authors would like to thank the robotics team robot0nfire: Nico Kratky, Nico Leidenfrost,\\ Sebastian Schaffler, Christine Zeh, Sascha Zemann;\\ Dr. Michael Stifter for making the existence of our team possible; Daniel Maximilian Swoboda for answering all paper related questions; the KIPR development team without whom the Wallaby Controller would not exist.

\begin{thebibliography}{1}

\bibitem{Sublime Text 3:Sublime HQ}
Sublime HQ, \emph{Sublime Text 3}, \url{https://www.sublimetext.com/3},\\ product page,
accessed February 9th 2017

\bibitem{Harrogate:KIPR}
KIPR, \emph{Harrogate}, \url{https://github.com/kipr/harrogate},\\ source code,
accessed February 9th 2017

\bibitem{Python 3.3.6:Python Foundation}
Python Foundation, \emph{Python 3.3.6}, \url{https://www.python.org/downloads/release/python-336/},\\ source code,
accessed February 9th 2017

\bibitem{behem0th:Christoph Heiss}
Christoph Heiss, \emph{behem0th}, \url{https://github.com/robot0nfire/behem0th},\\ source code,
accessed February 9th 2017

\bibitem{undergr0und:Philip Trauner}
Philip Trauner, \emph{undergr0und}, \url{https://github.com/robot0nfire/fl0w/wiki/undergr0und},\\ implementation notes,
accessed February 9th 2017

\bibitem{ws4py:Philip Trauner}
Philip Trauner, \emph{ws4py}, \url{https://github.com/robot0nfire/ws4py},\\ source code,
accessed February 9th 2017

\bibitem{The WebSocket Protocol:A. Melnikov}
A. Melnikov, \emph{The WebSocket Protocol}, \url{https://tools.ietf.org/html/rfc6455},\\ request for comment,
accessed February 9th 2017

\bibitem{watchdog:Yesudeep Mangalapilly}
Yesudeep Mangalapilly, \emph{watchdog}, \url{https://github.com/gorakhargosh/watchdog},\\ source code,
accessed February 9th 2017

\bibitem{JSON:T. Bray Ed.}
T. Bray, Ed., \emph{JSON}, \url{https://tools.ietf.org/html/rfc7159},\\ request for comment,
accessed February 9th 2017

\bibitem{bottle.py:Marcel Hellkamp}
Marcel Hellkamp, \emph{bottle.py}, \url{https://github.com/bottlepy/bottle},\\ source code,
accessed February 9th 2017

\bibitem{Flot:David Schnur}
David Schnur, \emph{Flot}, \url{https://github.com/flot/flot},\\ source code,
accessed February 9th 2017

\bibitem{jQuery:jQuery Foundation}
jQuery Foundation, \emph{jQuery}, \url{https://jquery.com/},\\ product page,
accessed February 9th 2017

\end{thebibliography}

\end{document}